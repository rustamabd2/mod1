name: test-staging

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    # Required for OIDC token generation
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      # Generate a signed OIDC JWT token from GitHub.
      - name: Get OIDC token
        id: oidc
        uses: actions/github-script@v7
        with:
          script: |
            const token = await core.getIDToken('https://registry-staging-599818415546.europe-west1.run.app')
            core.setOutput('token', token)

      # Exchange the OIDC JWT token for an access token from the registry.
      - name: Authenticate with registry
        run: |
          # Authenticate with the registry using OIDC
          RESPONSE=$(curl -sSL https://registry-staging-599818415546.europe-west1.run.app/login/oidc/github \
            -X POST \
            -H "Content-Type: application/json" \
            -d "{\"id_token\":\"${{ steps.oidc.outputs.token }}\"}")
          
          # Extract access token and save to environment
          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')
          
          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "Failed to get access token from registry"
            echo "Full response: $RESPONSE"
            exit 1
          fi
          
          echo "Successfully authenticated with registry"
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV

      # Use the new token as the bearer token with the registry normally.
      - name: Test registry access
        run: |
          # Use the access token to test registry access
          echo "Testing registry access with bearer token..."
          curl -sSL https://registry-staging-599818415546.europe-west1.run.app/v2/ \
            -H "Authorization: Bearer $ACCESS_TOKEN" || true
